---
title: 51单片机DS18B20获取温度
date: 2019-11-23 15:44:30
tags: 
        - 单片机
        - C语言
        - DS18B20
autor: hehung
categories: 51单片机
img: https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources@master/51-DS_18B20_temperature/Display.jpg
cover: false
coverImg: https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources@master/51-DS_18B20_temperature/Display.jpg 
top: false
summary: 使用51单片机完成对DS18B20的操作。DS18B20是一个单总线的温度采集芯片，能够学习DS18B20的应用。
---


>DS18B20是一个高精度的温度获取芯片，该芯片是单总线的，时序图也比较简单，最初发帖是在电子芯巴克。原帖子链接：[点我跳转](https://bbs.icxbk.com/thread-100156-1-1.html)

# 原理图

&emsp;&emsp;首先查看原理图，从下面的图中可以看出DS18B20是连接在P3.7引脚上面的。

![DS18B20接线图](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS_18B20_temperature/DS18B20.png "DS18B20接线图")

&emsp;&emsp;下面是数码管的原理图，因为温度数据要通过数码管显示出来。数码管的教程在前面已经写过了，在这里不再做介绍：[点我查看数码管操作](http://hehung.top/51-dan-pian-ji-shu-ma-guan-kong-zhi/)

![数码管原理图](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources@master/51-DS_18B20_temperature/Tube.png "数码管原理图")

&emsp;&emsp;从上面的原理图中可以看到，DS18B20的引脚是P3.7
&emsp;&emsp;数码管接法：
+ J12 ---  P0
+  A --- P1.0
+ B --- P1.1 
+ C --- P1.2

&emsp;&emsp;其中A,B,C是数码管的位选端口，在上一篇帖子里我已经说明了


# 程序编写

&emsp;&emsp;知道了原理图，接下来就是写程序了。
&emsp;&emsp;本来像这种函数比较多的程序一般都是要写在不同的文件里面的，使用模块化编程的。但是我为了简单，就写在了一个文件里。
&emsp;&emsp;我觉得代码还是写的比较规范的，注释也清楚，有需要的小伙伴直接拿去改下端口就可以用。

``` C
#include<reg52.h>

#define uchar unsigned char
#define uint unsigned int
#define SMG P0                //定义数码管的段选端口

//下述的A,B,C的信号进过译码器解码后可以控制8个数码管的显示
sbit LA=P1^0;                
sbit LB=P1^1;
sbit LC=P1^2;

sbit dq=P3^7;        //DS18B20的引脚

//下面的数组可以显示0-F
uchar code number[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
                                        0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};

//函数声明
void delay(int ms);                                                //延时函数
void change(int what);                                        //位选函数
void ds18b20_init();                                        //DS18B20初始化函数
void ds18b20_write_data(uchar dat);                //DS18B20写命令函数
uchar ds18b20_read_data();                                //DS18B20读数据函数
void ds18b20_read_temp(int *temp,int *xiao);        //DS18B20读温度函数
void display(int temp, int xiao);                //数码管显示函数
                                        
//主函数
void main()
{
        int temp,xiao;                //定义温度的整数和小数变量
        ds18b20_init();                //初始化
        
        while(1)
        {
                ds18b20_read_temp(&temp, &xiao);
                display(temp, xiao);
        }
}

//延时函数(短延时)
void delay(int ms)
{
        while(ms--);
}

//该函数可以选择某一个数码管显示
void change(int what)
{
        switch(what)
        {
                case 1:LC=0;LB=0;LA=0;break;
                case 2:LC=0;LB=0;LA=1;break;
                case 3:LC=0;LB=1;LA=0;break;
                case 4:LC=0;LB=1;LA=1;break;
                case 5:LC=1;LB=0;LA=0;break;
                case 6:LC=1;LB=0;LA=1;break;
                case 7:LC=1;LB=1;LA=0;break;
                case 8:LC=1;LB=1;LA=1;break;                
        }
}

//初始化函数
void ds18b20_init()
{
            dq=1;
         delay(5);
         dq=0;
         delay(400);
         dq=1;
         delay(300);
}
void ds18b20_write_data(uchar dat)
{
     uchar i;
         for(i=0;i<8;i++)
         {
             dq=0;
                 dq=dat&0x01;
                 delay(2);
                 dq=1;
                 dat>>=1;
         } 
         delay(4);    
}
uchar ds18b20_read_data()
{
          uchar i,v;
          for(i=0;i<8;i++)
          {
              dq=0;
                  v>>=1;
                  dq=1;
                  if(dq)
                     v|=0x80;
                  delay(4);
          }
          return v;
}
void ds18b20_read_temp(int *temp,int *xiao)
{          
         uchar a,b;
     ds18b20_init();
         ds18b20_write_data(0xcc);
         ds18b20_write_data(0x44);
         delay(200);

         ds18b20_init();
         ds18b20_write_data(0xcc);
         ds18b20_write_data(0xbe);                //读温度
         a=ds18b20_read_data();          //读出温度低位
         b=ds18b20_read_data();           //读出温度高位
         b<<=4;
         b+=(a&0xf0)>>4;
         *temp=b;                                //温度整数部分
         *xiao=a&0x0f;                        
         *xiao=*xiao/1.6;                //温度小数部分
}

void display(int temp, int xiao)
{
        change(1);
        SMG=number[temp/10];
        delay(100);
        SMG = 0;
        delay(30);         //消除暗影

        change(2);
        SMG=number[temp%10];
        delay(100);
        SMG = 0;
        delay(30);         //消除暗影

        change(3);
        SMG=~0x7f;
        delay(100);
        SMG = 0;
        delay(30);         //消除暗影

        change(4);
        SMG=number[xiao];
        delay(100);
        SMG = 0;
        delay(30);         //消除暗影
}

```

# 运行结果

&emsp;&emsp;写好了程序之后就是验证我们的实验结果了，首先要知道DS18B20长得什么样的，在单片机的位置，如下图所示：

![DS18B20在单片机中的位置](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS_18B20_temperature/DS18B20_in_board.png "DS18B20在单片机中的位置")

&emsp;&emsp;可以想办法给DS18B20加热，温度数值就会增加。
&emsp;&emsp;如下图，我是用手给它捏住，它的温度就会上升。

![DS18B20在单片机中的位置](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS_18B20_temperature/Display_dynamic1.gif "DS18B20在单片机中的位置")

![DS18B20在单片机中的位置](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS_18B20_temperature/Display_dynamic2.gif "DS18B20在单片机中的位置")




