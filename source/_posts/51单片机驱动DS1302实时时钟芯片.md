---
title: 51单片机驱动DS1302实时时钟芯片
date: 2019-11-23 18:14:00
tags: 
        - 单片机
        - C语言
        - DS1302
autor: hehung
categories: 51单片机
img: https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/display.gif
cover: false
coverImg: https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/display.gif
top: false
summary: DS1302是一个高精度低功耗的实时时钟芯片，使用纽扣电池供电可以在单片机掉电的情况下保证时间的正常运行，该文讲述了使用51单片机来控制DS1302。
---

>很多初学51单片机的小伙伴都喜欢用定时器作为时间模拟显示，这是可以的，对于精度要求不是很高的场合是可以使用的，但是当精度要求很高的时候，使用定时器就不定了，因为51单片机的定时器的精度本来就不高，我们可以使用常见的时钟芯片：DS1302来进行时间的显示。

>DS1302会自动进行时间的自加，所以字需要写入初始时间就可以自动就行西东进行时间的获取了，不需要用户进行时间的处理。

>DS1302可以针对年月日星期时分秒进行处理。我们在程序中通过数码管进行显示时间，由于数码管只有8个，所以时间与年月日信息分开显示，通过独立按键8进行转换。

>以前发帖在电子芯巴克。原帖子链接：[点我跳转](https://bbs.icxbk.com/thread-100332-1-1.html)

# 原理图

&emsp;&emsp;首先查看电路原理图，看开发板上的DS1302的引脚，如下图。

![DS1302原理图](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/DS1302.png "DS1302原理图")

&emsp;&emsp;本文中使用到了按键，按键的原理图如下所示：

![按键原理图](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/key.png "按键原理图")

&emsp;&emsp;本文还使用到了数码管，之前写过数码管的驱动帖子，在这里就不做过多的介绍了，直接移步：[点我移步数码管操作](http://hehung.top/51-dan-pian-ji-shu-ma-guan-kong-zhi/)

&emsp;&emsp;从上面的原理图中我们知道了使用到的器件的连线引脚定义如下：

```C

//DS1302时钟芯片引脚定义
sbit sck=P3^6;
sbit io=P3^4;
sbit rst=P3^5;

//数码管位选引脚定义
sbit LA = P1^0;
sbit LB = P1^1;
sbit LC = P1^2;

//按键引脚定义
sbit KEY = P2^0;
```


# DS1302

## 参考手册

&emsp;&emsp;DS1302的时序相对而言比较复杂，请看详细的资料文档说明：
[点我下载DS1302中文手册](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/DS1302_chinese_manual.pdf)

## 时序图

&emsp;&emsp;如下图所示：

![时序图](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/Sequence_diagram.png "时序图")

&emsp;&emsp;根据时序图来进行读/写字节，可以看到SCLX在由低变高就是写，由高变低就是读，连续读/写8个字节。

## 时间操作寄存器

&emsp;&emsp;如下图所示：

![时序图](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/registers.png "时序图")

可以看到读/写都有不同的寄存器，每个寄存器代表了不同的日期信息，需要哪个日期就读/写哪个寄存器就行了。


# 程序编写

&emsp;&emsp;下面是代码。
``` C
#include<reg52.h>
#include<intrins.h>

#define uchar unsigned char
#define uint unsigned int

//DS1302时钟芯片引脚定义
sbit sck=P3^6;
sbit io=P3^4;
sbit rst=P3^5;

//数码管位选引脚定义
sbit LA = P1^0;
sbit LB = P1^1;
sbit LC = P1^2;

//按键引脚定义
sbit KEY = P2^0;

//数码管的数字
//下面的数组可以显示0-F
uchar code smg_D[]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
                                        0x7f,0x6f,~0xbf};

uchar time_data[7]={18,4,4,13,11,59,50};                //年星期月日时分秒
uchar write_add[7]={0x8c,0x8a,0x88,0x86,0x84,0x82,0x80};                //写地址命令
uchar read_add[7]={0x8d,0x8b,0x89,0x87,0x85,0x83,0x81};                        //读地址命令
uchar disp[8];

void delay_ms(uint q)
{
     uint w;
         for(;q>0;q--)
            for(w=110;w>0;w--);
}

void delay_us(uint q)
{
         for(;q>0;q--);
}

void delay_nop()
{
    _nop_();
        _nop_();
        _nop_();
        _nop_();
        _nop_();
}

//该函数可以选择某一个数码管显示
void change(int what)
{
        switch(what)
        {
                case 1:LC=0;LB=0;LA=0;break;
                case 2:LC=0;LB=0;LA=1;break;
                case 3:LC=0;LB=1;LA=0;break;
                case 4:LC=0;LB=1;LA=1;break;
                case 5:LC=1;LB=0;LA=0;break;
                case 6:LC=1;LB=0;LA=1;break;
                case 7:LC=1;LB=1;LA=0;break;
                case 8:LC=1;LB=1;LA=1;break;                
        }
}
         
void reset() //重置
{
        rst=0;_nop_();
        sck=0;_nop_();
        rst=1;_nop_();
}

//写数据函数
void write_data(uchar dat)
{
    uchar i;
        for(i=0;i<8;i++)
        {
            sck=0;
                io=dat&0x01;
                delay_nop();delay_nop();delay_nop();
                dat>>=1;
                sck=1;
        }        
}

//写数据与命令函数
void write_add_data(uchar add,uchar dat)
{
    reset();
        rst=1;
        write_data(add);
        delay_nop();         delay_nop();
        write_data(dat);
        rst=0;
        _nop_();_nop_();_nop_();_nop_();
        io=0;
        sck=1;
}

//阅读数据函数
uchar read_dat(uchar add)
{
    uchar i,v;
    reset();
        delay_nop();
        write_data(add);
        for(i=0;i<8;i++)
        {
            v>>=1;
                sck=0;
            if(io)
                        v|=0x80;
                sck=1;
                delay_nop();delay_nop();delay_nop();
        }
        rst=0;
        sck=0;
        delay_nop();         
        sck=1;
        io=1;
        return v;
}

//设置时间函数
void set()
{
   uchar i,j;
   for(i=0;i<7;i++)
   {
        j=time_data[i]/10;
                time_data[i]=time_data[i]%10;
                time_data[i]=time_data[i]+j*16;
                delay_nop();
   }                                          
   write_add_data(0x8e,0x00);          //去除写保护
   _nop_();
   for(i=0;i<7;i++)
   {
        write_add_data(write_add[i],time_data[i]);
                delay_nop();
   }
   write_add_data(0x8e,0x80);                           //加写保护
}

//于都时间函数
void readtime()
{
        uchar i;
        for(i=0;i<7;i++)
        {
            time_data[i]=read_dat(read_add[i]);
                write_add_data(0x00,0x00);               //重点啊
        }
}

//将时分秒处理方便显示
void chuli()                //处理数据函数
{
    disp[0]=time_data[4]/16;
        disp[1]=time_data[4]%16;  
        disp[2]=10;
        disp[3]=time_data[5]/16;
        disp[4]=time_data[5]%16;
        disp[5]=10;
        disp[6]=time_data[6]/16;
        disp[7]=time_data[6]%16;
}

//将年月日处理方便显示
void chuli1()                //处理数据函数
{
    disp[0]=time_data[0]/16;
        disp[1]=time_data[0]%16;  
        disp[2]=10;
        disp[3]=time_data[2]/16;
        disp[4]=time_data[2]%16;
        disp[5]=10;
        disp[6]=time_data[3]/16;
        disp[7]=time_data[3]%16;
}
//函数时分秒
void display()
{
    uchar i;
    for(i=0;i<8;i++)
        {
            change(i+1);
                P0=smg_D[disp[i]];
                delay_us(50); 
                P0 = 0;
                delay_us(10);         //消除暗影            
        }
}

//主函数
void main()
{                   
        set();
        while(1)
        {
            readtime();
                display();
                
                if(KEY == 0)
                {
                        chuli1();                //处理年月日
                }else
                {
                        chuli();                //处理时分秒
                }        
        }
}
```

<font color=blue>注意：上述程序中，我是用按键8来进行年与日与时分秒的切换，按下按键8（P2.0引脚）就会显示年月日，放开就会显示时间。</font>

# 运行结果展示

》时间显示效果

![时间显示](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/display2.jpg "时间显示")

<font size=2>通过按按键8可以进行时间，日期的切换。</font>

》日期显示效果

![时间显示](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/display3.jpg "时间显示")

》时间动态显示

![时间显示](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/display.gif "时间显示")


# 附件

附上程序：[点我下载DS1302工程](https://cdn.jsdelivr.net/gh/hehung/cdn-jsDelivr-hehung-blog-sources/51-DS1302/DS1302_project.zip)

